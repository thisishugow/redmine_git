services:
  redmine:
    # 關鍵：使用 "build: ." 來指定 "使用當前目錄的 Dockerfile"
    # 而不是 "image: redmine:latest"
    build: .
    container_name: super_redmine_app
    restart: always
    ports:
      - "3000:3000"
    volumes:
      - redmine_files:/usr/src/redmine/files
      - redmine_themes:/usr/src/redmine/public/themes # (可選) 持久化主題
      - redmine-repositories:/usr/src/redmine/repositories

    # --------------------------------------------------------
    # 關鍵：SMTP (電子郵件) 和資料庫配置
    # --------------------------------------------------------
    environment:
      # --- 資料庫 (連接到下面的 postgres_db 服務) ---
      REDMINE_DB_TYPE: postgresql
      REDMINE_DB_POSTGRES: postgres_db
      REDMINE_DB_HOST: postgres_db
      REDMINE_DB_DATABASE: redmine
      REDMINE_DB_USERNAME: redmine
      REDMINE_DB_PASSWORD: "redmine" # ⚠️ 換成您的密碼

      # --- (可選) SMTP (以其他自訂 Mail Server 為例) ---
      # REDMINE_SMTP_HOST: "mail.your-company.com"
      # REDMINE_SMTP_PORT: 587
      # REDMINE_SMTP_USER: "sender@your-company.com"
      # REDMINE_SMTP_PASSWORD: "password"

  gitfetcher:
    build:
      context: ./plugins/gitfetcher
      dockerfile: Dockerfile
    container_name: super_redmine_gitfetcher
    restart: unless-stopped
    ports:
      - "8080:8080"
    volumes:
      # 配置檔案（建議先複製 config.example.yaml 到專案根目錄）
      - ./gitfetcher-config.yaml:/app/config.yaml

      # SSH keys（需要先準備好）
      - ./ssh_keys:/root/.ssh:ro

      # 與 Redmine 共享 repositories volume
      - redmine-repositories:/repos

      # Logs 輸出
      - ./plugins/gitfetcher/logs:/app/logs
    environment:
      - TZ=Asia/Taipei

  github-sync:
    build:
      context: ./plugins/github-sync
      dockerfile: Dockerfile
    container_name: super_redmine_github_sync
    restart: unless-stopped
    volumes:
      # 配置檔案（支援熱更新）
      - ./github-sync-config.yaml:/app/config.yaml:ro

      # Logs 輸出
      - ./plugins/github-sync/logs:/app/logs
    environment:
      # PostgreSQL 連線（與 Redmine 共用資料庫）
      - POSTGRES_HOST=postgres_db
      - POSTGRES_PORT=5432
      - POSTGRES_DB=redmine
      - POSTGRES_USER=redmine
      - POSTGRES_PASSWORD=redmine
      - POSTGRES_SCHEMA=redmine_github_sync
      - POSTGRES_SSLMODE=disable

      # 配置檔路徑
      - CONFIG_PATH=/app/config.yaml

      # 時區
      - TZ=Asia/Taipei
    depends_on:
      - postgres_db

  postgres_db:
    image: postgres:15-alpine
    container_name: super_redmine_db
    restart: always
    environment:
      POSTGRES_DB: redmine
      POSTGRES_USER: redmine
      POSTGRES_PASSWORD: "redmine" # ⚠️ 必須與上面一致
    volumes:
      - redmine_postgres_data:/var/lib/postgresql/data

# 定義 Docker 卷
volumes:
  redmine_files:
  redmine_themes:
  redmine_postgres_data:
  redmine-repositories: